<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Dreams</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>

<body>
    <script type="text/javascript">
        /*class depart extends Phaser.Scene {
            constructor() {
                super("depart");
            }
        }
        function preload() {
            this.load.image("tiles", "assets/Sprite_Sheet.png")
            this.load.tilemapTiledJSON("map", "Map_Zelda_Like.JSON");
            this.load.image('star', 'assets/star.png');
            this.load.spritesheet('perso', 'assets/perso.png',
                { frameWidth: 32, frameHeight: 34 });

        }
    

        function create(){
            this.add.image(400, 300, 'sky');
            this.add.image(400, 300, 'star');

            //game.tKey = game.input.keyboard.addKey( 't')
        }

        var platforms;
        var player;
        var cursors;
        var stars;
        var score;
        score = 0
        var bombs = false;
        var gameOver = false;
        var spacebar
        var keyT

        function checkDash(player, direction, velocity) {
            if ((Phaser.Input.Keyboard.JustDown(spacebar))) {
                //console.log("DASJH ON")
                this.player.setVelocityX(velocity);
                this.player.dash = true;
                this.player.dashCounter = 0;
            }
        }
        function checkJump(player) {
            if (this.player.jumpCount == undefined) {
                this.player.jumpCount = 0;
            }

            if (this.player.jumpCount <= 0 && Phaser.Input.Keyboard.JustDown(doubleJump)) {
                this.player.setVelocityY(-330); //alors vitesse verticale négative
                this.player.jumpCount += 1;
            }

            if (this.player.jumpCount > 0 && this.player.body.touching.down) {
                this.player.jumpCount = 0;
            }
        }
    
        function create() {

            this.player = this.physics.add.sprite(100, 450, 'perso');
            this.player.setBounce(0.2);
            this.player.setCollideWorldBounds(true);
            this.physics.add.collider(this.player, platforms);
            this.anims.create({
                key: 'left',
                frames: this.anims.generateFrameNumbers('perso', { start: 0, end: 3 }),
                frameRate: 10,
                repeat: -1
            });
            this.anims.create({
                key: 'turn',
                frames: [{ key: 'perso', frame: 4 }],
                frameRate: 20
            });
            this.anims.create({
                key: 'right',
                frames: this.anims.generateFrameNumbers('perso', { start: 5, end: 8 }),
                frameRate: 10,
                repeat: -1
            });
            cursors = this.input.keyboard.createCursorKeys();
            scoreText = this.add.text(16, 16, 'score: 0', { fontSize: '32px', fill: '#000' });
            //affiche un texte à l’écran, pour le score
            stars = this.physics.add.group({
                key: 'star', repeat: 11,
                setXY: { x: 12, y: 0, stepX: 70 }
            });
            stars.children.iterate(function (child) {
                child.setBounceY(Phaser.Math.FloatBetween(0.4, 0.8));
            }); //chaque étoile va rebondir un peu différemment
            this.physics.add.collider(stars, platforms);
            //et collisionne avec les plateformes
            this.physics.add.overlap(player, stars, collectStar, null, this);
            //le contact perso/étoile ne génère pas de collision (overlap)
            //mais en revanche cela déclenche une fonction collectStar
            bombs = this.physics.add.group();
            this.physics.add.collider(bombs, platforms);
            this.physics.add.collider(player, bombs, hitBomb, null, this);

            this.input.keyboard.enabled = true;
            spacebar = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);
            keyT = this.input.keyboard.addKey('t');
            doubleJump = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.UP);
            this.cameras.main.setBounds(0, 0, 1920 * 3, 600);
            this.cameras.main.setSize(600, 600);
            this.cameras.main.startFollow(this.player);
        }

        function update() {
            if (Phaser.Input.Keyboard.JustDown(keyT)) {
                console.log("TOUCHE T!!!!!")
            }

            if (cursors.left.isDown) { //si la touche gauche est appuyée
                if (this.player.dash) {
                    this.player.dashCounter++;
                    if (this.player.dashCounter >= 20) {
                        this.player.dash = false;
                    }
                } else {
                    this.player.setVelocityX(100); //alors vitesse négative en X
                    this.player.anims.play('left', true); //et animation => gauche
                }

                checkDash(this.player, 'left', -600)
            }

            //else if (cursors.right.isDown){ //sinon si la touche droite est appuyée
            else if (cursors.right.isDown) { //sinon si la touche droite est appuyée
                if (this.player.dash) {
                    this.player.dashCounter++;
                    if (this.player.dashCounter >= 20) {
                        this.player.dash = false;
                    }
                } else {
                    this.player.setVelocityX(160); //alors vitesse positive en X
                    this.player.anims.play('right', true); //et animation => droite
                }
                checkDash(this.player, 'right', 600)
            } else { // sinon
                this.player.setVelocityX(160); //vitesse nulle
                this.player.anims.play('turn'); //animation fait face caméra
            }

            checkJump(this.player)
            /*if (Phaser.Input.Keyboard.JustDown( doubleJump ) && player.body.touching.down){
                //si touche haut appuyée ET que le perso touche le sol
                player.setVelocityY(-330); //alors vitesse verticale négative
                //(on saute)
            if(Phaser.Input.Keyboard.JustDown( doubleJump ) && !player.body.touching.down)  {
                player.setVelocityY(-330);
            } 
            }
        }
    

        function hitBomb(player, bomb) {
            this.physics.pause();
            this.player.setTint(0xff0000);
            this.player.anims.play('turn');
            gameOver = true;
        }
        function collectStar(player, star) {
            this.star.disableBody(true, true); // l’étoile disparaît
            this.score += 10; //augmente le score de 10
            scoreText.setText('Score: ' + score); //met à jour l’affichage du score 
            if (this.stars.countActive(true) === 0) {// si toutes les étoiles sont prises
                this.stars.children.iterate(function (child) {
                    this.child.enableBody(true, this.child.x, 0, true, true);
                }); // on les affiche toutes de nouveau
                var x = (this.player.x < 400) ? Phaser.Math.Between(400, 800) :
                    Phaser.Math.Between(0, 400);
                // si le perso est à gauche de l’écran, on met une bombe à droite
                // si non, on la met à gauche de l’écran
                var bomb = bombs.create(x, 16, 'bomb');
                this.bomb.setBounce(1);
                this.bomb.setCollideWorldBounds(true);
                this.bomb.setVelocity(Phaser.Math.Between(-200, 200), 20);
                this.bomb.allowGravity = false; //elle n’est pas soumise à la gravité
            }
        }*/

        //**********************************************************************//
        //                          Scène Départ                                //
        //**********************************************************************//
        class Depart extends Phaser.Scene {
            constructor() {
                super("depart");
            }

            preload() {
                this.load.image("ecran_titre", "assets/Ecran_titre.png"); // Charger l'image d'acceuil 
            }


            create() {


                this.imageAcceuil = this.physics.add.staticGroup();
                this.imageAcceuil.create(447, 225, "ecran_titre"); // Emplacement de l'image d'acceuil

                this.cursors = this.input.keyboard.createCursorKeys();
            }


            update() {
                if (this.cursors.space.isDown) { // En appyant sur la touche "espace"
                    this.scene.start("niveau1"); // On passe de la scene de l'image d'acceuil à la scene "niveau1" } }
                }
            }
            config = {
                type: Phaser.AUTO,
                width: 896, height: 448,
                physics: {
                    default: 'arcade',
                    arcade: {
                        debug: true
                    }
                },
            }
        }



        //**********************************************************************//
        //                          Scène Hub                                   //
        //**********************************************************************//
        class Hub extends Phaser.Scene {
            constructor() { super("hub"); }
            preload() { }


            create() {
                var platforms;
                var player;
                var cursors;
                var stars;
                var score;
                score = 0
                var bombs = false;
                var gameOver = false;
                var spacebar
                var keyT
            }


            update() { }
        }


        //**********************************************************************//
        //                          Scène Niveau 1                              //
        //**********************************************************************//
        class Niveau1 extends Phaser.Scene {
            constructor() { super("niveau1"); }

            preload() {
                this.load.image("tiles", "assets/Sprite_pour_test.png")
                this.load.image("tiles", "assets/Sprite_sheets.png")
                this.load.tilemapTiledJSON("map", "Map_Zelda_Like..JSON");
                this.load.image('star', 'assets/star.png');
                this.load.spritesheet('perso', 'assets/perso.png',
                    { frameWidth: 32, frameHeight: 34 });
                this.load.image('Bloc', 'assets/BLOCINVISIBLE.png');
                this.load.image('background', 'assets/Background_level_colereV3.png');
                
            }



            create() {


                const carteDuNiveau = this.add.tilemap("map");
                this.background = this.add.image(450, 200, 'background');
                const tileset = carteDuNiveau.addTilesetImage(
                    "Sprite_pour_test",
                    "tiles"
                );
                const decor = carteDuNiveau.addTilesetImage(
                    "Sprite_sheets",
                    "tiles"
                );
        
                this.background.setScrollFactor(0)
                this.decor = carteDuNiveau.createStaticLayer(
                    "decor",
                    tileset
                );
                this.sol = carteDuNiveau.createStaticLayer(
                    "bordures",
                    tileset
                );



                
                var positionactu
                var position
                var positionInter
                var VelocityX
                var config
                var platforms;
                var player;
                var cursors;
                var gameOver = false;
                var spacebar
                var keyT
                this.player = this.physics.add.sprite(0, 370, 'perso');
                this.player.setCollideWorldBounds(true);

                this.sol.setCollisionByProperty({ estSolide: true });
                this.physics.add.collider(this.player, platforms);

                this.physics.add.collider(this.player, this.sol);
                this.anims.create({
                    key: 'left',
                    frames: this.anims.generateFrameNumbers('perso', { start: 0, end: 3 }),
                    frameRate: 10,
                    repeat: -1
                });
                this.anims.create({
                    key: 'turn',
                    frames: [{ key: 'perso', frame: 4 }],
                    frameRate: 20
                });
                this.anims.create({
                    key: 'right',
                    frames: this.anims.generateFrameNumbers('perso', { start: 5, end: 8 }),
                    frameRate: 10,
                    repeat: -1
                });
                this.cursors = this.input.keyboard.createCursorKeys();
                this.input.keyboard.enabled = true;
                this.spacebar = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);
                this.keyT = this.input.keyboard.addKey('t');
                this.cameras.main.setBounds(0, 0, 15000, 4200);
                this.physics.world.setBounds(0, 0, 15000, 4200);
                this.cameras.main.startFollow(this.player);
                this.cameras.main.followOffset.set (-325, 0);
                this.player.body.gravity.y = 200;
                this.cameras.main.zoom = 1;
                
            };





            update() {
                console.log(this.player.body.blocked.right)
                if (this.cursors.left.isDown) { //si la touche gauche est appuyée
                    this.player.setVelocityX(300); //alors vitesse négative en X
                    this.player.anims.play('left', true);
                }
                else if (this.cursors.right.isDown) { //sinon si la touche droite est appuyée
                    this.player.setVelocityX(600); //alors vitesse positive en X
                    this.player.anims.play('right', true);
                }
                else { // sinon
                    this.player.setVelocityX(400); //vitesse nulle
                    this.player.anims.play('turn');
                }
                if (this.cursors.up.isDown && this.player.body.blocked.down) {
                    this.player.setVelocityY(-270);

                }
                if (this.player.body.velocity.x <= 0 && (this.player.body.onFloor())) {
                    console.log("caca")
                    this.gameOver = true
                }

                if (this.gameOver == true) {
                    this.scene.restart()
                    this.gameOver = false
                }
                if (this.player.body.blocked.right){
                    this.gameOver = true;
                    this.player.scene.scene.restart();
                }
            }
        }
        config = {
            type: Phaser.AUTO,
            width: 896, height: 448,
            physics: {
                default: 'arcade',
                arcade: {
                    debug: true
                }
            },
        }


        //**********************************************************************//
        //                          Scène Niveau 2                              //
        //**********************************************************************//
        class Niveau2 extends Phaser.Scene {
            constructor() { super("Niveau2"); }
            preload() { }


            create() {
                var platforms;
                var player;
                var cursors;
                var stars;
                var score;
                score = 0
                var bombs = false;
                var gameOver = false;
                var spacebar
                var keyT
            }


            update() { }
        }
        //**********************************************************************//
        //                          Scène Niveau 3                              //
        //**********************************************************************//
        class Niveau3 extends Phaser.Scene {
            constructor() { super("Niveau3"); }
            preload() { }


            create() { }


            update() { }
        }





        var config = {
            type: Phaser.AUTO,
            width: 896, height: 448,
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 400, x: 200 },
                    debug: true
                }
            },

            scene: [Depart, Hub, Niveau1, Niveau2, Niveau3]

        };
        new Phaser.Game(config);




    </script>
</body>

</html>